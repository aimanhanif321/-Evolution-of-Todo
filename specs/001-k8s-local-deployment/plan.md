# Implementation Plan: Phase IV — Local Kubernetes Deployment

**Branch**: `001-k8s-local-deployment` | **Date**: 2026-01-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-k8s-local-deployment/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following Spec-Driven Development principles.

## Summary

Transform Taskora from a deployed web application into a cloud-native AI-operated platform by containerizing frontend (Next.js) and backend (FastAPI) services, deploying to Minikube local Kubernetes cluster, defining all infrastructure as Helm charts, and enabling AI-driven operations via kubectl-ai, Kagent, and Gordon.

## Technical Context

**Language/Version**:
- Frontend: TypeScript 5.3.0, Node.js 18+
- Backend: Python 3.11+
- Infrastructure: YAML (Helm templates), Shell scripts

**Primary Dependencies**:
- Frontend: Next.js 16.0.0, React 18.2.0, Tailwind CSS 3.3.6, better-auth 0.2.0
- Backend: FastAPI 0.104.1, SQLModel 0.0.16, Cohere 5.11.0+, Uvicorn 0.24.0
- Infrastructure: Docker, Minikube, Helm 3.x, kubectl, kubectl-ai, Kagent, Gordon

**Storage**: PostgreSQL 15 (containerized with PersistentVolumeClaim)

**Testing**:
- Backend: pytest 7.4.3
- Infrastructure: helm lint, helm template, kubectl dry-run

**Target Platform**: Local Kubernetes (Minikube) on Docker Desktop (Windows/macOS/Linux)

**Project Type**: Web application (frontend + backend + database)

**Performance Goals**:
- Application accessible within 1 minute of pods running
- Complete stack deployment within 10 minutes from clean state
- Container builds complete in under 5 minutes

**Constraints**:
- Minikube resource allocation: 4 CPU, 8GB RAM, 40GB disk
- Frontend image size < 500MB
- Backend image size < 1GB
- No pods enter OOMKilled state

**Scale/Scope**:
- Single-node local cluster
- 2 frontend replicas, 3 backend replicas, 1 database instance
- Local development and validation environment

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| Specification Supremacy | PASS | All infrastructure defined via Helm charts (spec-driven) |
| AI-First Operations | PASS | kubectl-ai, Kagent, Gordon integrated for AI-driven ops |
| Declarative Everything | PASS | No imperative scripts; all YAML/Helm templates |
| Immutable Infrastructure | PASS | Containers never modified in place; new builds required |
| GitOps Principles | PASS | Git repo is single source of truth for code + infrastructure |
| Multi-Stage Builds | PASS | Required by FR-002 |
| Non-Root Execution | PASS | Required by FR-003 |
| HEALTHCHECK Instructions | PASS | Required by FR-004 and FR-010 |
| No Secrets in Images | PASS | Required by FR-005 and FR-012 |
| Helm Lint Validation | PASS | Required by FR-014 |

**Gate Status**: PASS - All constitution principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/001-k8s-local-deployment/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
│   └── helm-values-schema.json
└── tasks.md             # Phase 2 output (/sp.tasks command)
```

### Source Code (repository root)

```text
# Web application structure (existing)
backend/
├── src/
│   ├── main.py           # FastAPI entry point
│   ├── database.py       # SQLModel configuration
│   ├── models/           # Data models (user, task, conversation, message)
│   ├── services/         # Business logic (auth, chat, agent)
│   ├── api/              # API routers (auth, task, chat)
│   ├── mcp/              # MCP tools integration
│   └── dependencies/     # Dependency injection
├── alembic/              # Database migrations
├── requirements.txt
├── Dockerfile            # NEW: To be created
└── .dockerignore         # NEW: To be created

frontend/
├── src/
│   ├── app/              # Next.js App Router pages
│   ├── components/       # React components
│   ├── context/          # React Context (AuthContext)
│   ├── lib/              # API client
│   └── services/         # Chat service
├── package.json
├── Dockerfile            # NEW: To be created
└── .dockerignore         # NEW: To be created

# Infrastructure (NEW: To be created)
helm/
└── taskora/
    ├── Chart.yaml
    ├── values.yaml
    ├── values-dev.yaml
    ├── values-prod.yaml
    └── templates/
        ├── _helpers.tpl
        ├── frontend/
        │   ├── deployment.yaml
        │   └── service.yaml
        ├── backend/
        │   ├── deployment.yaml
        │   └── service.yaml
        ├── database/
        │   ├── statefulset.yaml
        │   ├── service.yaml
        │   └── pvc.yaml
        ├── ingress.yaml
        ├── configmap.yaml
        └── secrets.yaml

# Kubernetes support files (NEW: To be created)
k8s/
├── minikube-setup.sh     # Cluster initialization script
└── README.md             # K8s-specific documentation
```

**Structure Decision**: Existing web application structure preserved. New `helm/` directory created for Kubernetes infrastructure specifications. Optional `k8s/` directory for setup scripts.

## Complexity Tracking

> No constitution violations requiring justification. All decisions align with cloud-native principles.

| Decision | Rationale | Alternative Rejected |
|----------|-----------|---------------------|
| Single Helm chart for all services | Simplified deployment, atomic rollbacks | Separate charts per service - adds coordination complexity for local dev |
| PostgreSQL in cluster | Production parity, PVC testing | External Neon DB - doesn't test persistence layer |
| Minikube with Docker driver | Best Windows/macOS compatibility | Kind, K3s - less tooling support for AI agents |

## Implementation Phases

### Phase 0: Research & Decisions

**Focus Areas:**
1. Dockerfile best practices for Next.js production builds
2. Dockerfile best practices for FastAPI/Uvicorn
3. Helm chart structure patterns for multi-service applications
4. Minikube ingress configuration for local access
5. kubectl-ai installation and configuration
6. Gordon CLI usage for Dockerfile generation
7. Kagent deployment requirements

**Output**: [research.md](./research.md)

### Phase 1: Design & Contracts

**Deliverables:**
1. **data-model.md**: Kubernetes resource definitions (Deployment, Service, ConfigMap, Secret, PVC, Ingress)
2. **contracts/**: Helm values schema defining configurable parameters
3. **quickstart.md**: Step-by-step deployment guide

**Output**: [data-model.md](./data-model.md), [contracts/](./contracts/), [quickstart.md](./quickstart.md)

### Phase 2: Task Generation

**Scope**: Generate actionable tasks for implementation via `/sp.tasks` command.

**Output**: [tasks.md](./tasks.md) (generated by separate command)

## Dependencies Graph

```
┌─────────────────┐
│   Dockerfiles   │
│ (frontend/backend)│
└────────┬────────┘
         │ builds into
         ▼
┌─────────────────┐
│ Container Images │
└────────┬────────┘
         │ referenced by
         ▼
┌─────────────────┐     ┌─────────────────┐
│  Helm Charts    │────▶│ K8s Manifests   │
└────────┬────────┘     └────────┬────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│   Minikube      │◀────│ kubectl apply   │
│   Cluster       │     │ / helm install  │
└─────────────────┘     └─────────────────┘
```

## Risk Mitigation

| Risk | Mitigation Strategy |
|------|---------------------|
| Minikube resource exhaustion | Define conservative resource requests/limits; test with monitoring |
| Large container images | Multi-stage builds; .dockerignore; layer optimization |
| Database data loss | Test PVC persistence before proceeding; document restore procedure |
| AI tools unavailable | Document manual kubectl/docker alternatives as fallback |
| Network connectivity issues | Implement proper health checks and readiness probes |

## Success Validation

Post-deployment verification commands:
```bash
# All pods running
kubectl get pods -n taskora

# Services accessible
kubectl get svc -n taskora

# Ingress configured
kubectl get ingress -n taskora

# Application accessible
minikube service taskora-frontend --url

# Helm release status
helm status taskora

# AI tools operational
kubectl-ai "show me pod status"
```
